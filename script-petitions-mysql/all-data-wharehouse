SELECT 
    w.id_warehouse AS 'ID almacén',
    w.name AS 'Nombre almacén',
    w.locality AS 'Localidad',
    w.adress AS 'Dirección',
    u.id_user AS 'ID usuario',
    u.name AS 'Nombre usuario',
    u.surname AS 'Apellido usuario',
    u.rol AS 'Rol usuario',
    t.plate AS 'Placa camión'
FROM 
    warehouse w
LEFT JOIN 
    user u ON w.id_warehouse = u.asigned_id_warehouse
LEFT JOIN 
    truck t ON u.id_user = t.driver_id_user;

/* Si se quiere pedir un id en concreto

 WHERE 
    w.id_warehouse = 3; */

/* Si se quiere que los almacenes estén en una sola línea

SELECT 
    w.id_warehouse AS 'ID Almacén',
    w.name AS 'Nombre Almacén',
    w.locality AS 'Localidad',
    w.adress AS 'Dirección',
    GROUP_CONCAT(
        CONCAT(u.name, ' ', u.surname, ' (Rol: ', u.rol, 
               IF(t.plate IS NOT NULL, CONCAT(', Camión: ', t.plate), ''), ')')
        ORDER BY u.id_user SEPARATOR '; '
    ) AS 'Usuarios y Camiones'
FROM 
    warehouse w
LEFT JOIN 
    user u ON w.id_warehouse = u.asigned_id_warehouse
LEFT JOIN 
    truck t ON u.id_user = t.driver_id_user
GROUP BY 
    w.id_warehouse, w.name, w.locality, w.adress;
*/


/* Para exportar en formato JSON */

SELECT JSON_OBJECT(
    'ID_wharehouse', w.id_warehouse,
    'Wharehouse_name', w.name,
    'Locality', w.locality,
    'Adress', w.adress,
    'Users', JSON_ARRAYAGG(
        JSON_OBJECT(
            'ID_user', u.id_user,
            'Name', u.name,
            'Surname', u.surname,
            'Rol', u.rol,
            'Truck', IFNULL(t.plate, '')
        )
    )
) AS Wharehouse
FROM 
    warehouse w
LEFT JOIN 
    user u ON w.id_warehouse = u.asigned_id_warehouse
LEFT JOIN 
    truck t ON u.id_user = t.driver_id_user
GROUP BY 
    w.id_warehouse;

